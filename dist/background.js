(()=>{function e(e){for(var o=0,t=0;t<e.length;t++)o=(o<<5)-o+e.charCodeAt(t),o|=0;return Math.abs(o)}function o(e){var o=e.hostname,t=o.split("."),r="";if(t.length>2){var a=t[t.length-2]+"."+t[t.length-1];r=["co.uk","com.au","gov.uk","co.in"].includes(a)?t[t.length-3]+"."+a:t[t.length-2]+"."+t[t.length-1]}else 2==t.length&&(r=o);return r}chrome.action.onClicked.addListener((function(e){chrome.tabs.create({url:"options.html"})})),chrome.runtime.onMessage.addListener((function(t,r,a){if("updateBlocklist"===t.type){switch(t.action){case"add":l=t.url,c=a,chrome.storage.local.get({blocklist:[],domainNames:[]},(function(t){var r=t.blocklist,a=new Set(t.domainNames),n=o(new URL(l));console.log(a,n),a.has(n)||-1===r.indexOf(l)&&(r.push(l),a.add(n),chrome.storage.local.set({blocklist:r,domainNames:Array.from(a)},(function(){!function(t){var r=o(new URL(t)),a=e(r),l={id:a,priority:1,action:{type:"redirect",redirect:{url:"http://localhost:8000/App.html/softblock"}},condition:{urlFilter:"*://*".concat(r,"/*"),resourceTypes:["main_frame"]}};chrome.declarativeNetRequest.updateDynamicRules({addRules:[l]});var c={id:a+1,priority:2,action:{type:"allow"},condition:{urlFilter:"*://music.".concat(r,"/*"),resourceTypes:["main_frame"]}};chrome.declarativeNetRequest.updateDynamicRules({addRules:[c]})}(l),c({status:"Blocklist updated",blocklist:r})})))}));break;case"remove":!function(t,r){chrome.storage.local.get({blocklist:[],domainNames:[]},(function(a){var l=a.blocklist,c=new Set(a.domainNames),n=o(new URL(t)),s=l.indexOf(t);s>-1&&(l.splice(s,1),c.delete(n),chrome.storage.local.set({blocklist:l,domainNames:Array.from(c)},(function(){!function(t){var r=e(o(new URL(t)));chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:[r]},(function(){console.log("Removing rule for URL:",t)}))}(t),r({status:"Blocklist updated",blocklist:l})})))}))}(t.url,a);break;case"clear":chrome.storage.local.clear((function(){console.log("Local blocklist has been cleared upon reload/startup.")})),chrome.declarativeNetRequest.getDynamicRules((function(e){var o=e.map((function(e){return e.id}));chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:o},(function(){chrome.runtime.lastError?console.error("Failed to remove rules:",chrome.runtime.lastError):console.log("All dynamic rules have been cleared.")}))}));break;case"fetch":!function(e){chrome.storage.local.get({blocklist:[]},(function(o){o.blocklist?e({status:"success",blocklist:o.blocklist}):e({status:"error",blocklist:[],message:"No blocklist found"})}))}(a)}return!0}var l,c})),chrome.webRequest.onBeforeRedirect.addListener((function(e){var t=new URL(e.url),r=o(t);chrome.storage.local.get({domainNames:[]},(function(e){new Set(e.domainNames).has(r)&&chrome.storage.local.set({interceptedURL:t.toString()},(function(){console.log("URL before redirect saved:",t)}))}))}),{urls:["<all_urls>"]},["responseHeaders"])})();